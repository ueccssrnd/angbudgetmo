// Generated by CoffeeScript 1.6.3
var BudgetMo, Visuals;

BudgetMo = (function() {
  function BudgetMo() {}

  BudgetMo.prototype.vars = {
    base_url: "/",
    tpl_path: "public/tpl/",
    user: "anonymous",
    logged: 0,
    counter: 0
  };

  BudgetMo.prototype.init = function() {
    this.ui.build();
    this.listen();
    return Visuals.prototype.drawGraph();
  };

  BudgetMo.prototype.listen = function() {
    $('#lightbox').on('click', '.light-close', function(e) {
      return BudgetMo.prototype.ui.lightbox.hide();
    });
    return $('.graph-picker').on('click', 'a', function(e) {
      var current, k, numberWithCommas, sector, serviceList, v, _ref, _results;
      sector = $(this).data('sector');
      Visuals.prototype.updateGraph(sector);
      $('.graph-parts-nav').find('a.active').removeClass('active');
      $(this).addClass('active');
      BudgetMo.prototype.vars.counter++;
      current = Visuals.prototype.vars.data.custom.allocations[BudgetMo.prototype.vars.counter];
      $('.cat-sector').text(current.sector);
      numberWithCommas = function(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };
      $('.sector-budget').find('.cash').text("" + (numberWithCommas(parseInt(current.amount))));
      serviceList = $('.bubble').find('ul').html("");
      _ref = current.assignments;
      _results = [];
      for (k in _ref) {
        v = _ref[k];
        _results.push(serviceList.append("<li><img src='assets/img/' alt=''><p><span class='items-count'>" + (numberWithCommas((Visuals.prototype.vars.data.total - Visuals.prototype.temp.remaining) / v.amount)) + "</span> <span class='item-name'>" + v.full_name + "</span> (<span class='item-price'>" + v.amount + " </span>)"));
      }
      return _results;
    });
  };

  BudgetMo.prototype.ui = {
    vars: {
      breadcrumbs: [],
      page: {},
      content_tpl: "home"
    },
    build: function() {},
    lightbox: {
      show: function() {
        return $('#lightbox').show();
      },
      hide: function() {
        return $('#lightbox').hide();
      }
    }
  };

  return BudgetMo;

})();

Visuals = (function() {
  function Visuals() {}

  Visuals.prototype.vars = {
    data: {
      total: 0,
      gov: [10, 50, 80, 30, 150],
      collated: [60, 70, 80, 90, 100],
      custom: {
        "name": {
          "id": "3",
          "full_name": "Darll2",
          "user_type": "citizen",
          "email": "aryll2@gov.ph"
        },
        "allocations": [
          {
            "sector": "Social Services",
            "budget_allocation": "97",
            "amount": "942800000",
            "category_id": "1",
            "assignments": [
              {
                "full_name": "Health facility",
                "amount": "5",
                "unit": ""
              }, {
                "full_name": "Health worker",
                "amount": "117045",
                "unit": ""
              }, {
                "full_name": "Classroom",
                "amount": "873028",
                "unit": ""
              }, {
                "full_name": "Teacher",
                "amount": "259082",
                "unit": ""
              }, {
                "full_name": "Textbook",
                "amount": "195",
                "unit": ""
              }
            ]
          }, {
            "sector": "Economic Services",
            "budget_allocation": "96",
            "amount": "990200000",
            "category_id": "2",
            "assignments": [
              {
                "full_name": "Road",
                "amount": "12",
                "unit": "per km"
              }, {
                "full_name": "Seedline",
                "amount": "38",
                "unit": ""
              }, {
                "full_name": "Fist port",
                "amount": "416",
                "unit": ""
              }, {
                "full_name": "Fertilizer",
                "amount": "347",
                "unit": "per sack"
              }, {
                "full_name": "Livestock",
                "amount": "34",
                "unit": ""
              }
            ]
          }, {
            "sector": "General Public Services",
            "budget_allocation": "96",
            "amount": "964500000",
            "category_id": "3",
            "assignments": [
              {
                "full_name": "Carrier truck",
                "amount": "3",
                "unit": ""
              }, {
                "full_name": "Business permit",
                "amount": "4464",
                "unit": ""
              }, {
                "full_name": "NBI clearance",
                "amount": "150",
                "unit": ""
              }, {
                "full_name": "Passport",
                "amount": "2407",
                "unit": ""
              }, {
                "full_name": "NBI clearance",
                "amount": "150",
                "unit": ""
              }, {
                "full_name": "Visa",
                "amount": "328",
                "unit": ""
              }
            ]
          }, {
            "sector": "Debt Burden",
            "budget_allocation": "97",
            "amount": "977600000",
            "category_id": "4",
            "assignments": [
              {
                "full_name": "Debt",
                "amount": "338",
                "unit": "total"
              }
            ]
          }, {
            "sector": "Defense",
            "budget_allocation": "9",
            "amount": "92900000",
            "category_id": "5",
            "assignments": [
              {
                "full_name": "Aircraft",
                "amount": "35",
                "unit": "per plane"
              }, {
                "full_name": "Flood control structure",
                "amount": "46",
                "unit": ""
              }, {
                "full_name": "Vehicular radio",
                "amount": "2",
                "unit": ""
              }
            ]
          }
        ]
      }
    }
  };

  Visuals.prototype.temp = {
    remaining: 0,
    current: 0,
    saved: []
  };

  Visuals.prototype.init = function() {
    var color, height, radius, width;
    height = 400;
    width = 400;
    color = d3.scale.category20b();
    return radius = 150;
  };

  Visuals.prototype.drawGraph = function() {
    var arc, arcs, canvas, color, current, currentSector, data, doughnut, group, height, i, image, k, layout, numberWithCommas, radius, sectorCounter, serviceList, update, v, width, _i, _len, _ref, _ref1, _results;
    height = "100%";
    width = "100%";
    radius = 150;
    currentSector = $('.graph-picker').find('a.active').data('sector');
    _ref = Visuals.prototype.vars.data.custom.allocations;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      i = _ref[_i];
      Visuals.prototype.vars.data.total += parseInt(i.amount);
    }
    data = [0, Visuals.prototype.vars.data.total];
    color = ["gold", "#999"];
    image = currentSector;
    canvas = d3.select(".graph-preview .graph").append("svg").style("width", width).style("height", height);
    arc = d3.svg.arc().outerRadius(radius).innerRadius(radius * 0.8);
    layout = d3.layout.pie().sort(null).value(function(d) {
      return d;
    });
    group = canvas.append("g").attr("class", "graph-group").attr("transform", "translate(300,200)");
    group.append("circle").attr("cx", 0).attr("cy", 0).attr("r", radius * 0.8).attr("fill", "white");
    group.append("image").attr("xlink:href", "assets/img/" + image + "-150.png").attr("x", radius / 2 * -1).attr("y", radius / 2 * -1).attr("width", radius).attr("height", radius);
    arcs = group.selectAll(".arc").data(layout(data)).enter().append("g").attr("class", "arc");
    doughnut = arcs.append("path").attr("d", arc).attr("fill", function(d, i) {
      return color[i];
    }).attr("stroke", "#fff").attr("stroke-width", 2);
    $('.total-budget span').text(Visuals.prototype.vars.data.total);
    $(".a, .b, .c, .d").width(0);
    $("#slider-range-min").slider({
      range: "min",
      value: 0,
      min: 0,
      max: 100,
      slide: function(event, ui) {
        $(".a, .b, .c, .d").width(ui.value + "%");
        Visuals.prototype.temp.remaining = (100 - ui.value) / 100 * Visuals.prototype.vars.data.total;
        $('.total-budget span').text(Math.floor(Math.ceil(Visuals.prototype.temp.remaining)));
        return update(Visuals.prototype.temp.current = Visuals.prototype.vars.data.total - Visuals.prototype.temp.remaining, Visuals.prototype.temp.remaining);
      }
    });
    $(".ui-slider-handle").html("&#xf053;&#xf054;");
    update = function(value, remaining) {
      var newData;
      newData = [value, remaining];
      arcs.data(layout(newData));
      return arcs.select("path").attr("d", arc);
    };
    sectorCounter = 0;
    current = Visuals.prototype.vars.data.custom.allocations[sectorCounter];
    $('.cat-sector').text(current.sector);
    numberWithCommas = function(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    };
    $('.sector-budget').find('.cash').text("" + (numberWithCommas(parseInt(current.amount))));
    serviceList = $('.bubble').find('ul');
    _ref1 = current.assignments;
    _results = [];
    for (k in _ref1) {
      v = _ref1[k];
      _results.push(serviceList.append("<li><img src='assets/img/' alt=''><p><span class='items-count'>" + (numberWithCommas((Visuals.prototype.vars.data.total - Visuals.prototype.temp.remaining) / v.amount)) + "</span> <span class='item-name'>" + v.full_name + "</span> (<span class='item-price'>" + v.amount + " </span>)"));
    }
    return _results;
  };

  Visuals.prototype.updateGraph = function(sector) {
    var arc, canvas, group, image, layout, radius;
    Visuals.prototype.vars.data.total = Visuals.prototype.temp.remaining;
    $("#slider-range-min").slider("value", $("#slider-range-min").slider("option", "min"));
    $(".a, .b, .c, .d").width(0);
    arc = d3.svg.arc().outerRadius(radius).innerRadius(radius * 0.8);
    layout = d3.layout.pie().sort(null).value(function(d) {
      return d;
    });
    radius = 150;
    canvas = d3.select(".graph-preview");
    group = canvas.select(".graph-group");
    return image = group.select("image").attr("xlink:href", "assets/img/" + sector + "-150.png");
  };

  return Visuals;

})();

$(document).ready(function() {
  var app;
  app = new BudgetMo;
  return app.init();
});
